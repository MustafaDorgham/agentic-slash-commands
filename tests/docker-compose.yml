services:
  # Test Claude Code installation only
  claude:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: agentic-claude
    volumes:
      - ..:/home/testuser/agentic-slash-commands
    command: >
      bash -c "
        cd /home/testuser/agentic-slash-commands &&
        echo '=== Testing Claude Code Installation ===' &&
        echo '' &&
        bash scripts/install-claude.sh &&
        echo '' &&
        echo '=== Verification ===' &&
        echo 'Commands installed:' &&
        ls -la ~/.claude/commands/ | grep -E '^l' | wc -l | xargs echo 'Total symlinks:' &&
        echo '' &&
        echo 'Sample symlinks:' &&
        (cd ~/.claude/commands/ && pwd) &&
        ls -la ~/.claude/commands/ | grep -E '^l' | head -3
      "

  # Test Codex installation only
  codex:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: agentic-codex
    volumes:
      - ..:/home/testuser/agentic-slash-commands
    command: >
      bash -c "
        cd /home/testuser/agentic-slash-commands &&
        echo '=== Testing Codex Installation ===' &&
        echo '' &&
        bash scripts/install-codex.sh &&
        echo '' &&
        echo '=== Verification ===' &&
        echo 'Commands installed:' &&
        ls -la ~/.codex/prompts/ | grep -E '^l' | wc -l | xargs echo 'Total symlinks:' &&
        echo '' &&
        echo 'Sample symlinks:' &&
        (cd ~/.codex/prompts/ && pwd) &&
        ls -la ~/.codex/prompts/ | grep -E '^l' | head -3
      "

  # Test both platforms (direct installation)
  universal:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: agentic-universal
    volumes:
      - ..:/home/testuser/agentic-slash-commands
    command: >
      bash -c "
        cd /home/testuser/agentic-slash-commands &&
        echo '=== Testing Both Platforms Installation ===' &&
        echo '' &&
        echo 'Installing Claude Code...' &&
        bash scripts/install-claude.sh > /dev/null 2>&1 &&
        echo 'Installing Codex...' &&
        bash scripts/install-codex.sh > /dev/null 2>&1 &&
        echo '' &&
        echo '=== Verification ===' &&
        echo 'Claude Code commands:' &&
        ls -la ~/.claude/commands/ 2>/dev/null | grep -c '^l' | xargs echo '  Symlinks:' &&
        echo 'Codex commands:' &&
        ls -la ~/.codex/prompts/ 2>/dev/null | grep -c '^l' | xargs echo '  Symlinks:' &&
        exit 0
      "

  # Test idempotency (running installer twice)
  idempotent:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: agentic-idempotent
    volumes:
      - ..:/home/testuser/agentic-slash-commands
    command: >
      bash -c "
        cd /home/testuser/agentic-slash-commands &&
        echo '=== Testing Idempotency ===' &&
        echo '' &&
        echo 'First run:' &&
        yes | timeout 10 bash install.sh >/dev/null 2>&1
        echo 'First install completed' &&
        echo '' &&
        echo 'Second run (should skip all):' &&
        yes | timeout 10 bash install.sh >/dev/null 2>&1
        echo 'Second install completed' &&
        echo '' &&
        echo '=== Verification ===' &&
        ls -la ~/.claude/commands/ 2>/dev/null | grep -c '^l' | xargs echo 'Claude symlinks:' &&
        ls -la ~/.codex/prompts/ 2>/dev/null | grep -c '^l' | xargs echo 'Codex symlinks:' &&
        exit 0
      "

  # Test symlink integrity
  symlinks:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: agentic-symlinks
    volumes:
      - ..:/home/testuser/agentic-slash-commands
    command: >
      bash -c "
        cd /home/testuser/agentic-slash-commands &&
        echo '=== Testing Symlink Integrity ===' &&
        echo '' &&
        yes | timeout 10 bash install.sh > /dev/null 2>&1
        echo 'Checking all symlinks point to valid files...' &&
        echo '' &&
        all_valid=true
        for file in ~/.claude/commands/*.md; do
          if [ -L \"$$file\" ]; then
            target=$$(readlink \"$$file\")
            if [ -f \"$$target\" ]; then
              echo \"✓ $$(basename \"$$file\") -> $$target\"
            else
              echo \"✗ $$(basename \"$$file\") -> $$target (BROKEN)\"
              all_valid=false
            fi
          fi
        done
        echo ''
        if [ \"$$all_valid\" = true ]; then
          echo '✅ All symlinks are valid'
          exit 0
        else
          echo '❌ Some symlinks are broken'
          exit 1
        fi
      "

  # Test warning messages
  warnings:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: agentic-warnings
    volumes:
      - ..:/home/testuser/agentic-slash-commands
    command: >
      bash -c "
        cd /home/testuser/agentic-slash-commands &&
        echo '=== Testing Warning Messages ===' &&
        echo '' &&
        echo 'Testing main installer warning...' &&
        output=$$(echo 'n' | bash install.sh 2>&1) &&
        if echo \"$$output\" | grep -q 'WARNING: This installer will overwrite existing commands'; then
          echo '✓ Main installer shows overwrite warning'
        else
          echo '✗ Main installer missing overwrite warning'
          exit 1
        fi &&
        if echo \"$$output\" | grep -q 'Installation cancelled'; then
          echo '✓ Main installer allows cancellation'
        else
          echo '✗ Main installer does not allow cancellation'
          exit 1
        fi &&
        echo '' &&
        echo 'Testing Claude Code installer warning...' &&
        output=$$(bash scripts/install-claude.sh 2>&1) &&
        if echo \"$$output\" | grep -q 'WARNING: Existing commands'; then
          echo '✓ Claude Code installer shows warning'
        else
          echo '✗ Claude Code installer missing warning'
          exit 1
        fi &&
        echo '' &&
        echo 'Testing Codex installer warning...' &&
        output=$$(bash scripts/install-codex.sh 2>&1) &&
        if echo \"$$output\" | grep -q 'WARNING: Existing prompts'; then
          echo '✓ Codex installer shows warning'
        else
          echo '✗ Codex installer missing warning'
          exit 1
        fi &&
        echo '' &&
        echo 'Testing Gemini installer warning...' &&
        output=$$(bash scripts/install-gemini.sh 2>&1) &&
        if echo \"$$output\" | grep -q 'WARNING: Existing commands'; then
          echo '✓ Gemini installer shows warning'
        else
          echo '✗ Gemini installer missing warning'
          exit 1
        fi &&
        echo '' &&
        echo '✅ All warning messages are present'
      "

  # Interactive test environment (for manual testing)
  interactive:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: agentic-interactive
    volumes:
      - ..:/home/testuser/agentic-slash-commands
    stdin_open: true
    tty: true
    command: bash
